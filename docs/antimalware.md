# Anti-malware evasion
This document describes how to start experimenting with evading the anti-malware models using Counterfit.

Note that this is just an example illustrating how to use Counterfit to evade a target model, participants in the competition should try to modify existing attacks, or develop their own attacks.

It is assumed that you are using the competition docker image and have persisted your credentials from https://mlsec.io/myuser/ using the `mlsec_creds` command as described in [Getting Started](getting_started.md).

<!-- vscode-markdown-toc -->
* [Interact with a target](#interact-with-a-target)
* [Select an attack](#select-an-attack)
* [Set attack parameters](#set-attack-parameters)
* [Run the attack](#run-the-attack)
* [Upload the results](#upload-the-results)

<!-- vscode-markdown-toc-config
	numbering=false
	autoSave=true
	/vscode-markdown-toc-config -->
<!-- /vscode-markdown-toc -->


## <a name='interact-with-a-target'></a>Interact with a target

To begin, select the `ember` target from the list of available targets.
You can show the entire list of targets by running `list targets`, then select EMBER with `interact ember`.

```shell
counterfit> list targets

Name             Type             Input Shape      Location

----------------------------------------------------------------------------------------------------------------------------------------
moviereviews     text             (1,)             counterfit/targets/moviereviews/movie_reviews_sentiment_analysis.pt
creditfraud      numpy            (30,)            counterfit/targets/creditfraud/creditfraud_sklearn_pipeline.pkl
ember            pe               (1,)             counterfit/targets/ember/ember_model.txt.gz
satelliteimages  image            (3, 256, 256)    counterfit/targets/satelliteimages/satellite-image-params-airplane-stadium.h5
tutorial         image            (1, 28, 28)      counterfit/targets/tutorial/mnist_sklearn_pipeline.pkl
mlsecphish       html             (1,)             http://127.0.0.1:8085/eval

counterfit> interact ember
Finished loading model, total used 1000 iterations
WARNING: EMBER feature version 2 were computed using lief version 0.9.0-
WARNING:   lief version 0.11.5-37bc2c9 found instead. There may be slight inconsistencies
WARNING:   in the feature calculations.
scanning malware sample info from counterfit/targets/ember/MLSEC_samples.zip
100%|██████████████████████████████████████████████████████████████████████████████████| 50/50 [00:00<00:00, 187245.71it/s]
ember>
```

## <a name='select-an-attack'></a>Select an attack

To select an attack, start by loading the `mlsecevade` framework -- a special framework introduced for the MLSec competition.
```shell
ember> load mlsecevade

[+] Framework loaded successfully!

ember>
```

Then you can list all avaliable attacks in the framework with `list attacks`.
```shell
ember> list attacks

Name                       Type             Category         Tags             Framework
----------------------------------------------------------------------------------------
hop_skip_jump-pe           evasion          blackbox         pe               mlsecevade
randdescent-html           evasion          blackbox         html             mlsecevade
zoo-html                   evasion          blackbox         html             mlsecevade
hyperopt-pe                evasion          blackbox         pe               mlsecevade
zoo-pe                     evasion          blackbox         pe               mlsecevade
hop_skip_jump-html         evasion          blackbox         html             mlsecevade
boundary-html              evasion          blackbox         html             mlsecevade
hyperopt-html              evasion          blackbox         html             mlsecevade
boundary-pe                evasion          blackbox         pe               mlsecevade
```

To select an attack, run `use ATTACK_NAME`, for instance `use hyperopt-pe`.
```shell
ember> use hyperopt-pe

[+] Using hyperopt-pe 034364fe

ember>hyperopt-pe>
```

## <a name='set-attack-parameters'></a>Set attack parameters
You can get additional information about the selected attack by running `show info`.
```shell
ember>hyperopt-pe> show info

Target Information

-----------------------------------------------------------------------------------------------------------
               model name  ember
          model data type  pe
           model endpoint  counterfit/targets/ember/ember_model.txt.gz
        model input shape  (1,)
 model output classes (2)  ['benign', 'malicious']

Attack Information

-----------------------------------------------------------------------------------------------------------
              attack name  hyperopt-pe
              attack type  evasion
          attack category  blackbox
              attack tags  ['pe']
         attack framework  mlsecevade
              attack docs   uses hyperopt's Tree Parzen Estimator (TPE) for black-box optimization   of a
                           parameter space that consists of function-preserving file modifications

Attack Parameter (type)      Default       Current
-----------------------------------------------------
          max_evals (int)  20            20
       sample_index (int)  0             0
       target_class (int)  0             0

ember>hyperopt-pe>
```

In the `hyperopt-pe` attack, we have the following parameters:
* `max_evals`: the maximum number of iterations of the attack to run;
* `sample_index`: the index of the sample to be modified;
* `target_class`: the objective class of the attack. In this case, we are want the malware sample to be recognized as belonging to the `benign` class.

To change the value of any attack parameter you can use the `set PARAMETER_NAME=PARAMETER_VALUE` command, eg: `set sample_index=2` to target the test sample with index 2.

You can also run an attack on a list of samples by passing a list definition to the set command. For instance:
```shell
ember>hyperopt-pe> set sample_index=`list(range(5))`

Attack Parameter (type)      Default       Previous        New
-------------------------------------------------------------------
          max_evals (int)  20            20
       sample_index (int)  0             2             [0, 1, 2, 3,
                                                       4]
       target_class (int)  0             0

ember>hyperopt-pe>
```


## <a name='run-the-attack'></a>Run the attack

Finally, you can run the attack with the selected parameters by just typing `run`.

```shell

ember>hyperopt-pe> run

[+] Running hyperopt-pe on ember

Try to read 0x1 bytes from 0x538b (538c) which is bigger than the binary's size
Data of section section '.data' is too large (0xffffff60)
Try to read 0x1 bytes from 0xb60 (b61) which is bigger than the binary's size
100%|████████████████████████████████████████████████████| 20/20 [02:06<00:00,  6.32s/trial, best loss: 0.8814285397529602]
100%|████████████████████████████████████████████████████| 20/20 [01:41<00:00,  5.09s/trial, best loss: 0.9777542948722839]
100%|████████████████████████████████████████████████████| 20/20 [00:48<00:00,  2.41s/trial, best loss: 0.9838868379592896]
100%|███████████████████████████████████████████████████| 20/20 [01:13<00:00,  3.65s/trial, best loss: 0.06831271201372147]
100%|███████████████████████████████████████████████████| 20/20 [01:09<00:00,  3.48s/trial, best loss: 0.15466655790805817]

Increase terminal width to show results.

[+] 2/5 succeeded

[+] Elapsed time [sec] 437.8

[+] Total number of queries [rate] 105 (4.2 sec/query)

     Sample Index      Label (conf)     Attack Label (conf)  filesize
---------------------------------------------------------------------
1.               0  malicious (1.0000)   malicious (0.9683)   6683068
2.               1  malicious (0.9968)   malicious (0.9366)  10703272
3.               2  malicious (1.0000)   malicious (0.9775)   8434176
4.               3  malicious (1.0000)      benign (0.9006)   7651004
5.               4  malicious (1.0000)      benign (0.8170)  11537920

ember>hyperopt-pe>
```

The summary will show the label, and model confidence, for the original data point, and the resulting label, model confidence (on the target label) and file size after the attack.
In the example above, the attack managed to craft 2/5 evasive samples.

**Note**: the final attack report will show the confidence score for the benign class as `1 - P(malicious)`. For instance, if a successful attack manages to lower the output of the model on a malicious sample to 0.6544759, which is below the configured thereshold of 0.8336, the report will show the final `Attack Label` as `benign (0.3455241)`.


## <a name='upload-the-results'></a>Upload the results
When you are satisfied, you may upload your submission as an encrpyted ZIP file automatically:
```
ember>hyperopt-pe> malware_upload 

[+] Successfully uploaded counterfit/targets/ember/results/mlsecmalware.zip
```


You will not see your score immediately at [https://mlsec.io/pscores/] since the backend system must validate each of the samples in your submission.  Please check back in 30 minutes.  Also, please note that there is a rate limit on uploads, so you should use of the `malware_upload` command sparingly.